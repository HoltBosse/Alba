import{N as t,ah as e,A as n,v as o,G as s,aF as r,n as i}from"../index-Bk8j52k6.mjs";import{P as a,c as d,T as c,b as l}from"../tiptap-pm-entry-C1u8SbQo.mjs";import{G as p}from"../index-CKNipKJW.mjs";var u=(t,e)=>null!==e.view.domAtPos(t).node.offsetParent,m=(t,e)=>{const{state:o,view:r,extensionManager:i}=t,{schema:a,selection:d}=o,{empty:c,$anchor:l}=d,m=!!i.extensions.find(t=>"gapCursor"===t.name);if(!c||l.parent.type!==a.nodes.detailsSummary||!m)return!1;if("right"===e&&l.parentOffset!==l.parent.nodeSize-2)return!1;const f=s(t=>t.type===a.nodes.details)(d);if(!f)return!1;const h=n(f.node,t=>t.type===a.nodes.detailsContent);if(!h.length)return!1;if(u(f.start+h[0].pos+1,t))return!1;const y=o.doc.resolve(f.pos+f.node.nodeSize),g=p.findFrom(y,1,!1);if(!g)return!1;const{tr:b}=o,A=new p(g);return b.setSelection(A),b.scrollIntoView(),r.dispatch(b),!0},f=t.create({name:"details",content:"detailsSummary detailsContent",group:"block",defining:!0,isolating:!0,allowGapCursor:!1,addOptions:()=>({persist:!1,openClassName:"is-open",HTMLAttributes:{}}),addAttributes(){return this.options.persist?{open:{default:!1,parseHTML:t=>t.hasAttribute("open"),renderHTML:({open:t})=>t?{open:""}:{}}}:[]},parseHTML:()=>[{tag:"details"}],renderHTML({HTMLAttributes:t}){return["details",r(this.options.HTMLAttributes,t),0]},...i({nodeName:"details",content:"block"}),addNodeView(){return({editor:t,getPos:e,node:n,HTMLAttributes:o})=>{const s=document.createElement("div"),i=r(this.options.HTMLAttributes,o,{"data-type":this.name});Object.entries(i).forEach(([t,e])=>s.setAttribute(t,e));const a=document.createElement("button");a.type="button",s.append(a);const d=document.createElement("div");s.append(d);const c=t=>{if(void 0!==t)if(t){if(s.classList.contains(this.options.openClassName))return;s.classList.add(this.options.openClassName)}else{if(!s.classList.contains(this.options.openClassName))return;s.classList.remove(this.options.openClassName)}else s.classList.toggle(this.options.openClassName);const e=new Event("toggleDetailsContent"),n=d.querySelector(':scope > div[data-type="detailsContent"]');null==n||n.dispatchEvent(e)};return n.attrs.open&&setTimeout(()=>c()),a.addEventListener("click",()=>{if(c(),this.options.persist){if(t.isEditable&&"function"==typeof e){const{from:n,to:o}=t.state.selection;t.chain().command(({tr:t})=>{const n=e();if(!n)return!1;const o=t.doc.nodeAt(n);return(null==o?void 0:o.type)===this.type&&(t.setNodeMarkup(n,void 0,{open:!o.attrs.open}),!0)}).setTextSelection({from:n,to:o}).focus(void 0,{scrollIntoView:!1}).run()}}else t.commands.focus(void 0,{scrollIntoView:!1})}),{dom:s,contentDOM:d,ignoreMutation:t=>"selection"!==t.type&&(!s.contains(t.target)||s===t.target),update:t=>t.type===this.type&&(void 0!==t.attrs.open&&c(t.attrs.open),!0)}}},addCommands(){return{setDetails:()=>({state:t,chain:e})=>{var n;const{schema:o,selection:s}=t,{$from:r,$to:i}=s,a=r.blockRange(i);if(!a)return!1;const d=t.doc.slice(a.start,a.end);if(!o.nodes.detailsContent.contentMatch.matchFragment(d.content))return!1;const c=(null==(n=d.toJSON())?void 0:n.content)||[];return e().insertContentAt({from:a.start,to:a.end},{type:this.name,content:[{type:"detailsSummary"},{type:"detailsContent",content:c}]}).setTextSelection(a.start+2).run()},unsetDetails:()=>({state:t,chain:e})=>{const{selection:o,schema:r}=t,i=s(t=>t.type===this.type)(o);if(!i)return!1;const a=n(i.node,t=>t.type===r.nodes.detailsSummary),d=n(i.node,t=>t.type===r.nodes.detailsContent);if(!a.length||!d.length)return!1;const c=a[0],l=d[0],p=i.pos,u=t.doc.resolve(p),m={from:p,to:p+i.node.nodeSize},f=l.node.content.toJSON()||[],h=u.parent.type.contentMatch.defaultType,y=[null==h?void 0:h.create(null,c.node.content).toJSON(),...f];return e().insertContentAt(m,y).setTextSelection(p+1).run()}}},addKeyboardShortcuts(){return{Backspace:()=>{const{schema:t,selection:e}=this.editor.state,{empty:n,$anchor:o}=e;return!(!n||o.parent.type!==t.nodes.detailsSummary)&&(0!==o.parentOffset?this.editor.commands.command(({tr:t})=>{const e=o.pos-1,n=o.pos;return t.delete(e,n),!0}):this.editor.commands.unsetDetails())},Enter:({editor:t})=>{const{state:e,view:n}=t,{schema:s,selection:r}=e,{$head:i}=r;if(i.parent.type!==s.nodes.detailsSummary)return!1;const a=u(i.after()+1,t),d=a?e.doc.nodeAt(i.after()):i.node(-2);if(!d)return!1;const c=a?0:i.indexAfter(-1),p=o(d.contentMatchAt(c));if(!p||!d.canReplaceWith(c,c,p))return!1;const m=p.createAndFill();if(!m)return!1;const f=a?i.after()+1:i.after(-1),h=e.tr.replaceWith(f,f,m),y=h.doc.resolve(f),g=l.near(y,1);return h.setSelection(g),h.scrollIntoView(),n.dispatch(h),!0},ArrowRight:({editor:t})=>m(t,"right"),ArrowDown:({editor:t})=>m(t,"down")}},addProseMirrorPlugins(){return[new a({key:new d("detailsSelection"),appendTransaction:(t,o,s)=>{const{editor:r,type:i}=this;if(r.view.composing)return;if(!t.some(t=>t.selectionSet)||!o.selection.empty||!s.selection.empty)return;if(!e(s,i.name))return;const{$from:a}=s.selection;if(u(a.pos,r))return;const d=((t,e,n)=>{for(let o=t.depth;o>0;o-=1){const s=t.node(o),r=e(s),i=u(t.start(o),n);if(r&&i)return{pos:o>0?t.before(o):0,start:t.start(o),depth:o,node:s}}})(a,t=>t.type===i,r);if(!d)return;const l=n(d.node,t=>t.type===s.schema.nodes.detailsSummary);if(!l.length)return;const p=l[0],m="forward"===(o.selection.from<s.selection.from?"forward":"backward")?d.start+p.pos:d.pos+p.pos+p.node.nodeSize,f=c.create(s.doc,m);return s.tr.setSelection(f)}})]}}),h=t.create({name:"detailsContent",content:"block+",defining:!0,selectable:!1,addOptions:()=>({HTMLAttributes:{}}),parseHTML(){return[{tag:`div[data-type="${this.name}"]`}]},renderHTML({HTMLAttributes:t}){return["div",r(this.options.HTMLAttributes,t,{"data-type":this.name}),0]},addNodeView(){return({HTMLAttributes:t})=>{const e=document.createElement("div"),n=r(this.options.HTMLAttributes,t,{"data-type":this.name,hidden:"hidden"});return Object.entries(n).forEach(([t,n])=>e.setAttribute(t,n)),e.addEventListener("toggleDetailsContent",()=>{e.toggleAttribute("hidden")}),{dom:e,contentDOM:e,ignoreMutation:t=>"selection"!==t.type&&(!e.contains(t.target)||e===t.target),update:t=>t.type===this.type}}},addKeyboardShortcuts(){return{Enter:({editor:t})=>{const{state:e,view:n}=t,{selection:r}=e,{$from:i,empty:a}=r,d=s(t=>t.type===this.type)(r);if(!a||!d||!d.node.childCount)return!1;const c=i.index(d.depth),{childCount:p}=d.node;if(!(p===c+1))return!1;const u=d.node.type.contentMatch.defaultType,m=null==u?void 0:u.createAndFill();if(!m)return!1;const f=e.doc.resolve(d.pos+1),h=p-1,y=d.node.child(h),g=f.posAtIndex(h,d.depth);if(!y.eq(m))return!1;const b=i.node(-3);if(!b)return!1;const A=i.indexAfter(-3),v=o(b.contentMatchAt(A));if(!v||!b.canReplaceWith(A,A,v))return!1;const M=v.createAndFill();if(!M)return!1;const{tr:S}=e,T=i.after(-2);S.replaceWith(T,T,M);const L=S.doc.resolve(T),w=l.near(L,1);S.setSelection(w);const C=g,H=g+y.nodeSize;return S.delete(C,H),S.scrollIntoView(),n.dispatch(S),!0}}},...i({nodeName:"detailsContent"})}),y=t.create({name:"detailsSummary",content:"text*",defining:!0,selectable:!1,isolating:!0,addOptions:()=>({HTMLAttributes:{}}),parseHTML:()=>[{tag:"summary"}],renderHTML({HTMLAttributes:t}){return["summary",r(this.options.HTMLAttributes,t),0]},...i({nodeName:"detailsSummary",content:"inline"})}),g=f;export{f as Details,h as DetailsContent,y as DetailsSummary,g as default};
